<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feckenham Wake Bar</title>

  <style>
    :root{
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      --bg:#0b0b10;
      --card:#12121a;
      --card2:#161622;
      --text:#f5f7ff;
      --muted:#a8b0c3;
      --border: rgba(255,255,255,.10);
      --accent:#f59e0b;
      --accent2:#ef4444;
    }

    html, body{
      margin:0;
      min-height:100%;
      background: var(--bg);
      color: var(--text);
    }

    body{
      /* subtle top glow (keeps it ‚Äúpos‚Äù, not flashy) */
      background:
        radial-gradient(900px 600px at 20% 0%, rgba(245,158,11,.18), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(239,68,68,.16), transparent 55%),
        var(--bg);
    }

    header{
      position: sticky;
      top: 0;
      z-index: 20;
      padding: 16px 16px 10px 16px;
      background: rgba(10,10,16,.90);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    h1{
      margin: 0;
      font-size: 22px;
      font-weight: 900;
      text-align: center;
      letter-spacing: -0.02em;
    }

    .statusbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:center;
      margin-top: 10px;
    }
    .status-pill{
      font-size: 13px;
      padding: 3px 60px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 0px solid rgba(255,255,255,.10);
      color: rgba(245,247,255,.92);
      user-select:none;
    }
    .status-pill span{ font-weight: 900; }

    .tabs{
      display:flex;
      gap:10px;
      padding: 12px 12px 0 12px;
      background: rgba(10,10,16,.90);
      border-bottom: 0px solid rgba(255,255,255,.08);
      position: sticky;
      top: 76px; /* header height-ish; ok if slightly off */
      z-index: 19;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .tab{
      flex:1;
      padding: 12px 10px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
    }
    .tab.active{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #111;
      border: none;
      font-weight: 900;
    }

    main{ padding: 16px; max-width: 1100px; margin: 0 auto; background: transparent; }

    .twoCol{ display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 900px){ .twoCol{ grid-template-columns: 1.1fr .9fr; } }

    .panel{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 16px 50px rgba(0,0,0,1);
    }

    .row{ display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .muted{ color: var(--muted); font-size: 14px; }

    .grid{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px; }
    @media (min-width: 760px){ .grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
    @media (min-width: 1024px){ .grid{ grid-template-columns: repeat(4, minmax(0,1fr)); } }

    .drink{
      background: rgba(255,255,255,.02);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px;
      text-align: center;
      cursor: pointer;
      user-select: none;
      position: relative;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      transition: transform .05s ease;
    }
    .drink:active{ transform: scale(0.98); }
    .drink .name{ font-size: 18px; font-weight: 850; line-height: 1.1; text-align: center; }
    .drink .price{ font-size: 14px; color: var(--muted); text-align: center; margin-top: 6px; }

    /* tap flash + ripple */
    .drink.flash{
      outline: 3px solid rgba(245, 158, 11, 0.9);
      box-shadow: 0 0 0 6px rgba(245, 158, 11, 0.18);
    }
    .drink::after{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(circle at var(--rx, 50%) var(--ry, 50%), rgba(245,158,11,.35), transparent 55%);
      opacity: 0;
      transition: opacity 160ms ease;
      pointer-events:none;
    }
    .drink.flash::after{ opacity: 1; }

    table{ width:100%; border-collapse: collapse; }
    th, td{ padding: 10px 8px; border-bottom: 1px solid rgba(255,255,255,.08); text-align:left; }
    th{ font-size: 12px; text-transform: uppercase; letter-spacing: .05em; color: rgba(245,247,255,.80); }

    .qtyControls{ display:inline-flex; gap:6px; align-items:center; }

    .btn{
      padding: 10px 20px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor: pointer;
      font-weight: 800;
      transition: transform .05s ease;
    }
    .btn:active{ transform: scale(0.98); }
    .btn:disabled{ opacity: .3; cursor: not-allowed; }

    .btn.primary{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #111;
      border: none;
    }
    .btn.danger{
      background: rgba(255,255,255,.04);
      color: #ff6b6b;
      border: 1px solid rgba(255,107,107,.35);
    }

    #btn-complete{
      font-size: 20px;
      padding: 14px 14px;
      border-radius: 14px;
    }

    .bigTotal{ font-size: 42px; font-weight: 900; letter-spacing: -0.02em; }
    .spacer{ height: 10px; }

    /* Payment modal */
    #pay-modal{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,.65);
      z-index: 10000;
    }
    #pay-modal .pay-card{
      width: min(520px, 92vw);
      border-radius: 22px;
      padding: 18px;
      background: rgba(18,18,26,.96);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 24px 60px rgba(0,0,0,.55);
    }
    #pay-modal .pay-title{
      font-weight: 900;
      font-size: 22px;
      margin-bottom: 14px;
    }
    #pay-modal .pay-actions{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    #pay-modal .pay-actions .btn{
      padding: 16px 14px;
      font-size: 18px;
      border-radius: 16px;
    }

    /* Order complete overlay */
    #order-complete-overlay{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,.65);
      z-index: 9999;
    }
    #order-complete-overlay .oco-card{
      width: min(520px, 90vw);
      border-radius: 22px;
      padding: 22px 18px;
      text-align: center;
      background: rgba(18,18,26,.95);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 24px 60px rgba(0,0,0,.55);
    }
    #order-complete-overlay .oco-title{
      font-weight: 900;
      font-size: 26px;
      margin-bottom: 10px;
    }
    #order-complete-overlay .oco-total{
      font-weight: 950;
      font-size: 54px;
      margin: 6px 0 10px 0;
    }
    #order-complete-overlay .oco-sub{
      opacity: .8;
      font-size: 14px;
    }

    /* Orders detail panel tweaks */
    #order-detail .row{ gap: 10px; }
    #order-detail table th{ opacity: .85; }
    #order-detail table td{ padding: 10px 8px; }

/* Admin modal */
#admin-modal{
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,.65);
  z-index: 10001;
}
#admin-modal .admin-card{
  width: min(900px, 94vw);
  border-radius: 22px;
  padding: 18px;
  background: rgba(18,18,26,.96);
  border: 1px solid rgba(255,255,255,.12);
  box-shadow: 0 24px 60px rgba(0,0,0,.55);
}
#admin-modal .admin-title{
  font-weight: 950;
  font-size: 22px;
  margin-bottom: 4px;
}
#admin-modal input{
  width: 100%;
  padding: 10px 10px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: rgba(245,247,255,.95);
  font-weight: 700;
  outline: none;
}
#admin-modal input::placeholder{ color: rgba(245,247,255,.45); }

/* Drink thumbnails */
.thumb{
  width: 42px;
  height: 42px;
  border-radius: 12px;
  object-fit: cover;
  margin: 0 auto 10px auto;
  display: block;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
}

.thumb.placeholder{
  /* if a drink has no img, still keep layout consistent */
  background: rgba(255,255,255,.04);
}

/* Variants modal uses same styling as other modals */
#variant-modal{
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;

  /* stronger backdrop */
  background: rgba(0,0,0,.82);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);

  z-index: 10002;
}

    #variant-modal .admin-card{
  border: 1px solid rgba(255,255,255,.16);
  box-shadow: 0 30px 80px rgba(0,0,0,.70);
}
    
  
/* Held order chips (for Hold/Recall) */
.held-chip{
  display: inline-flex;
  gap: 10px;
  align-items: center;
  padding: 10px 12px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color: rgba(245,247,255,.95);
  font-weight: 850;
  cursor: pointer;
  user-select: none;
}
.held-chip .sub{
  font-weight: 700;
  color: rgba(245,247,255,.70);
  font-size: 12px;
  margin-top: 2px;
}
.held-chip .x{
  margin-left: 6px;
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.05);
  color: rgba(245,247,255,.85);
  font-weight: 950;
  cursor: pointer;
}

.held-chip.active{
  outline: 3px solid rgba(245, 158, 11, 0.9);
  box-shadow: 0 0 0 6px rgba(245, 158, 11, 0.18);
}

  
/* ===== Settings (Phase 1) ===== */
:root{
  --ui-scale: 1;
}

/* Scale the whole UI (works on iOS Safari) */
body{
  transform: scale(var(--ui-scale));
  transform-origin: top left;
  width: calc(100% / var(--ui-scale));
}

/* Settings button (top-left, out of the way) */
#btn-settings{
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 20000;
  width: 44px;
  height: 44px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  color: rgba(245,247,255,.95);
  font-weight: 900;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  -webkit-tap-highlight-color: transparent;
}
#btn-settings:active{ transform: scale(.98); }
html[data-theme="light"] #btn-settings{
  border-color: rgba(0,0,0,.14);
  background: rgba(0,0,0,.06);
  color: rgba(10,10,16,.92);
}

/* Modal backdrop + card */
#settings-modal{
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,.82);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: 20001;
}
#settings-modal .settings-card{
  width: min(520px, 92vw);
  border-radius: 22px;
  padding: 16px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(18,18,26,.96);
  box-shadow: 0 30px 80px rgba(0,0,0,.70);
}
#settings-modal .settings-title{
  font-weight: 950;
  font-size: 20px;
}
#settings-modal .settings-row{
  display: flex;
  gap: 10px;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
}
#settings-modal label{ font-weight: 800; }
#settings-modal .seg{
  display: inline-flex;
  gap: 8px;
  flex-wrap: wrap;
}
#settings-modal .seg button{
  padding: 10px 12px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: rgba(245,247,255,.95);
  font-weight: 850;
  cursor: pointer;
}
#settings-modal .seg button.active{
  outline: 2px solid rgba(245,158,11,.85);
  box-shadow: 0 0 0 6px rgba(245,158,11,.16);
}
#settings-modal input[type="range"]{ width: 100%; }

/* Theme switching without rewriting your whole CSS: use filters */
html[data-theme="light"]{
  filter: invert(1) hue-rotate(180deg);
}
html[data-theme="light"] img,
html[data-theme="light"] video,
html[data-theme="light"] canvas{
  filter: invert(1) hue-rotate(180deg);
}
html[data-theme="hc"]{
  filter: contrast(1.25) saturate(1.05);
}

</style>
</head>

<body>
  <header>
    <h1 id="app-title">Feckenham Wake Bar</h1>

    <div id="status-bar" class="statusbar">
      <div class="status-pill">Orders: <span id="sb-orders">0</span></div>
      <div class="status-pill">Revenue: <span id="sb-revenue">¬£0.00</span></div>
      <div class="status-pill">Cash: <span id="sb-cash">¬£0.00</span></div>
      <div class="status-pill">Card: <span id="sb-card">¬£0.00</span></div>
      <div class="status-pill">Last: <span id="sb-last">‚Äî</span></div>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" id="tab-order">New Order</button>
    <button class="tab" id="tab-orders">Previous Orders</button>
    <button class="tab" id="tab-summary">Summary</button>
  </div>

  <main>
    <!-- ORDER VIEW -->
    <section id="view-order">
      <div class="twoCol">
        <div>
          <div class="panel">
            <div class="row">
              <div>
                <div style="font-weight:900;">Drinks Menu</div>
                <div class="muted">Tap drinks to add to the current order.</div>
              </div>
              <button class="btn" id="btn-edit-note" title="Optional order note">Add Note</button>
            </div>
            <div class="spacer"></div>
            <div class="grid" id="drink-grid"></div>
          </div>
        </div>

        <div>
          <div class="panel">
            <div class="row">
              <div style="font-weight:900;">Current Order</div>
              <button class="btn danger" id="btn-clear-order">Clear</button>
            </div>
            <div class="spacer"></div>

            <div id="order-note" class="muted" style="display:none; margin-bottom: 8px;"></div>

            <table>
              <thead>
                <tr>
                  <th>Item</th>
                  <th style="width:160px;">Qty</th>
                  <th style="width:120px;">Line</th>
                </tr>
              </thead>
              <tbody id="order-lines">
                <tr><td colspan="3" class="muted">No items selected.</td></tr>
              </tbody>
            </table>

            <div class="spacer"></div>

            <div class="row">
              <div class="muted">Total</div>
              <div class="bigTotal" id="order-total">¬£0.00</div>
            </div>

            <div class="spacer"></div>

            <!-- HELD ORDERS TRAY -->
            <div id="held-wrap" style="display:none;">
              <div class="row">
                <div style="font-weight:900;">Held Orders</div>
                <div class="muted">Tap to recall</div>
              </div>
              <div id="held-list" class="row" style="gap:8px; flex-wrap:wrap; margin-top:10px;"></div>
            </div>
            <!-- END HELD ORDERS TRAY -->

            <div class="spacer"></div>

            
<div class="row" style="gap:8px;">
              <button class="btn" id="btn-undo">Undo</button>
              <button class="btn" id="btn-hold" disabled>Hold Order</button>
              <button class="btn danger" id="btn-clear-held" style="display:none;">Clear Hold</button>
              <button type="button" class="btn primary" id="btn-complete" disabled>Complete Order</button>
            </div>

            <div class="muted" style="margin-top:14px;">
              All orders saved locally.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ORDERS VIEW -->
    <section id="view-orders" style="display:none;">
      <div class="panel">
        <div class="row">
          <div>
            <div style="font-weight:900;">Orders</div>
            <div class="muted">Tap an order to view items.</div>
          </div>
          <div class="row" style="gap:8px;">
            <button class="btn" id="btn-export">Export CSV</button>
            <button class="btn danger" id="btn-clear-all">Clear Day</button>
          </div>
        </div>

        <div class="spacer"></div>
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Items</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="orders-list">
            <tr><td colspan="3" class="muted">No completed orders yet.</td></tr>
          </tbody>
        </table>

        <div id="order-detail" class="panel" style="display:none; margin-top:14px;"></div>
      </div>
    </section>

    <!-- SUMMARY VIEW -->
    <section id="view-summary" style="display:none;">
      <div class="panel">
        <div class="row">
          <div>
            <div style="font-weight:900;">Summary</div>
            <div class="muted">Totals for all completed orders.</div>
          </div>
          <button class="btn" id="btn-refresh-summary">Refresh</button>
        </div>

        <div class="spacer"></div>

        <div class="row">
          <div class="muted">Total Revenue</div>
          <div class="bigTotal" id="summary-revenue">¬£0.00</div>
        </div>

        <div class="spacer"></div>

        <table>
          <thead>
            <tr>
              <th>Drinks</th>
              <th style="width:120px;">Qty Sold</th>
              <th style="width:140px;">Sales</th>
            </tr>
          </thead>
          <tbody id="summary-table">
            <tr><td colspan="3" class="muted">No sales yet.</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Payment method modal -->
  <div id="pay-modal" aria-hidden="true">
    <div class="pay-card">
      <div class="pay-title">Select payment</div>

      <div class="pay-actions">
        <button type="button" class="btn primary" id="pay-card">üí≥ Card</button>
        <button type="button" class="btn primary" id="pay-cash">üí∑ Cash</button>
      </div>

      <button type="button" class="btn" id="pay-cancel" style="margin-top:12px; width:100%;">Cancel</button>
    </div>
  </div>

  <!-- Order complete overlay -->
  <div id="order-complete-overlay" aria-hidden="true">
    <div class="oco-card">
      <div class="oco-title">‚úÖ Order Complete</div>
      <div class="oco-total" id="oco-total">¬£0.00</div>
      <div class="oco-sub">Ready for the next order‚Ä¶</div>
    </div>
  </div>

<!-- Admin: Edit Menu -->
<div id="admin-modal" style="display:none;">
  <div class="admin-card">
    <div class="row" style="align-items:flex-start;">
      <div>
        <div class="admin-title">Admin ¬∑ Edit Menu</div>
        <div class="muted">Changes save on this device only.</div>
      </div>
      <button type="button" class="btn" id="admin-close">Close</button>
    </div>

    <div class="spacer"></div>

    <div class="row" style="gap:10px; flex-wrap:wrap;">
<button type="button" class="btn primary" id="admin-add">+ Add drink</button>
<button type="button" class="btn" id="admin-save">Save changes</button>
<button type="button" class="btn" id="admin-export">Export menu</button>
<button type="button" class="btn" id="admin-import">Import menu</button>
<button type="button" class="btn danger" id="admin-reset">Reset to default</button>
    </div>

    <div class="spacer"></div>

    <div style="overflow:auto; max-height: 55vh; border:1px solid rgba(255,255,255,.10); border-radius:14px;">
      <table style="margin:0;">
        <thead>
          <tr>
  <th style="width:180px;">ID</th>
  <th>Name</th>
  <th style="width:140px;">Price</th>
  <th style="width:220px;">Image</th>
  <th style="width:90px;"></th>
</tr>
        </thead>
        <tbody id="admin-menu-body"></tbody>
      </table>
    </div>

    <div class="muted" style="margin-top:10px;">
      Tip: long-press the title to open Admin.
    </div>
  </div>
</div>

  <!-- Variants modal -->
<div id="variant-modal" style="display:none;">
  <div class="admin-card" style="max-width:520px;">
    <div class="row">
      <div>
        <div class="admin-title" id="variant-title">Choose option</div>
        <div class="muted">Tap one to add to the order.</div>
      </div>
      <button type="button" class="btn" id="variant-close">Close</button>
    </div>

    <div class="spacer"></div>

    <div id="variant-list" class="grid" style="grid-template-columns:repeat(2,minmax(0,1fr));"></div>
  </div>
</div>
  
<script>

  function exportMenu(){
  // Use the live saved menu (not the draft)
  const payload = JSON.stringify(DRINKS, null, 2);

  // If supported, copy to clipboard (works on most modern browsers)
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(payload)
      .then(() => alert("Menu copied to clipboard.\n\nNow paste it into Import on your other device."))
      .catch(() => prompt("Copy this menu JSON:", payload));
  } else {
    // Fallback: show prompt so you can copy manually
    prompt("Copy this menu JSON:", payload);
  }
}

function importMenu(){
  const pasted = prompt("Paste menu JSON here:");
  if(pasted === null) return;

  let parsed;
  try{
    parsed = JSON.parse(pasted);
  } catch {
    alert("That didn‚Äôt look like valid JSON.");
    return;
  }

  if(!Array.isArray(parsed)){
    alert("Menu JSON must be an array of drinks.");
    return;
  }

  const cleaned = parsed.map(d => ({
    id: String(d.id || "").trim(),
    name: String(d.name || "").trim(),
    price: Number(d.price || 0),
    img: String(d.img || "").trim()
  }));

  const err = validateMenu(cleaned);
  if(err){
    alert("Import failed: " + err);
    return;
  }

  saveMenu(cleaned);

  // Refresh everything
  renderMenu();
  renderCurrentOrder();
  renderHeld();
  renderOrders();
  renderSummary();
  updateStatusBar();

  // If Admin is open, refresh the draft too
  if(document.getElementById("admin-modal").style.display !== "none"){
    adminDraft = DRINKS.map(d => ({...d}));
    renderAdminTable();
  }

  alert("Menu imported successfully.");
}

  
let adminDraft = [];

function openAdmin(){
  document.getElementById("admin-modal").style.display = "flex";
  adminDraft = DRINKS.map(d => ({...d}));
  renderAdminTable();
}
function closeAdmin(){
  document.getElementById("admin-modal").style.display = "none";
}

function renderAdminTable(){
  const body = document.getElementById("admin-menu-body");
  body.innerHTML = "";

  adminDraft.forEach((d, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
  <td><input data-k="id" data-i="${idx}" value="${escapeHtml(d.id)}"></td>
  <td><input data-k="name" data-i="${idx}" value="${escapeHtml(d.name)}"></td>
  <td><input data-k="price" data-i="${idx}" value="${Number(d.price).toFixed(2)}"></td>
  <td><input data-k="img" data-i="${idx}" value="${escapeHtml(d.img || "")}" placeholder="img/poretti.png"></td>
  <td><button type="button" class="btn danger" data-del="${idx}">Delete</button></td>
`;
    body.appendChild(tr);
  });

  body.querySelectorAll("input").forEach(inp => {
    inp.addEventListener("input", () => {
      const i = Number(inp.getAttribute("data-i"));
      const k = inp.getAttribute("data-k");
      if(k === "price"){
        const v = Number(String(inp.value).replace(/[^\d.]/g,""));
        adminDraft[i][k] = Number.isFinite(v) ? v : 0;
      } else {
        adminDraft[i][k] = inp.value;
      }
    });
  });

  body.querySelectorAll("button[data-del]").forEach(btn => {
    btn.addEventListener("click", () => {
      const i = Number(btn.getAttribute("data-del"));
      adminDraft.splice(i, 1);
      renderAdminTable();
    });
  });
}

function validateMenu(menuArr){
  const ids = new Set();
  for(const d of menuArr){
    if(!d.id || !d.name) return "Each drink needs an ID and a Name.";
    const id = d.id.trim();
    if(ids.has(id)) return `Duplicate ID: ${id}`;
    ids.add(id);
    const price = Number(d.price);
    if(!Number.isFinite(price) || price < 0) return `Invalid price for ${id}`;
  }
  return null;
}

function applyAdminMenu(){
  const cleaned = adminDraft.map(d => ({
  id: String(d.id || "").trim(),
  name: String(d.name || "").trim(),
  price: Number(d.price || 0),
  img: String(d.img || "").trim()
}));

  const err = validateMenu(cleaned);
  if(err){ alert(err); return; }

  saveMenu(cleaned);

  // Refresh screens
  renderMenu();
  renderCurrentOrder();
  renderHeld();
  renderOrders();
  renderSummary();
  updateStatusBar();

  closeAdmin();
}

  
  // ====== EDIT YOUR MENU HERE ======
  // Prices are in GBP.
  const DRINKS_DEFAULT = [
    { id:"cider", name:"Thatchers", price:4.75, img:"img/thatchers.png" },
    { id: "ipa",     name: "IPA",           price: 4.75 },
    { id: "gin",     name: "Gin",           price: 3.50 },
    { id: "mixer",   name: "Mixer",         price: 1.75 },
    { id: "soft",    name: "Soft Drink",    price: 1.50 },
    { id: "deposit", name: "Glass Deposit", price: 1.00 },
{ id:"poretti-half", name:"Poretti (Half)", price: 3.50, img:"img/poretti.png" },
{ id:"poretti-pint", name:"Poretti (Pint)", price: 4.75, img:"img/poretti.png" },

{ id:"wine-small",  name:"Wine (Small)",  price: 4.50, img:"img/whitewine.png" },
{ id:"wine-medium", name:"Wine (Medium)", price: 6.00, img:"img/whitewine.png" },
{ id:"wine-large",  name:"Wine (Large)",  price: 7.50, img:"img/whitewine.png" },
{ id:"wine-bottle", name:"Wine (Bottle)", price: 20.00, img:"img/whitewine.png" },
   
  ]; 
  const KEY_MENU = "popupbar_menu_override_v1";
const ADMIN_PIN = "1234"; // CHANGE THIS PIN

let DRINKS = loadMenu();

// Sub-menu groups: clicking a group opens options (which are normal DRINKS ids)
const VARIANT_GROUPS = [
  {
    id: "poretti",
    label: "Poretti",
    img: "img/poretti.png",          // optional (can remove)
    options: ["poretti-half", "poretti-pint"]
  },
  {
    id: "wineoptions",
    label: "Wine",
    img: "img/whitewine.png",             // optional
    options: ["wine-small", "wine-medium", "wine-large", "wine-bottle"]
  }
];

function loadMenu(){
  try{
    const raw = localStorage.getItem(KEY_MENU);
    if(!raw) return DRINKS_DEFAULT.slice();
    const parsed = JSON.parse(raw);
    if(!Array.isArray(parsed)) return DRINKS_DEFAULT.slice();
    return parsed.map(x => ({
  id: String(x.id || "").trim(),
  name: String(x.name || "").trim(),
  price: Number(x.price || 0),
  img: String(x.img || "").trim()
}));
  } catch {
    return DRINKS_DEFAULT.slice();
  }
}

function saveMenu(menuArr){
  localStorage.setItem(KEY_MENU, JSON.stringify(menuArr));
  DRINKS = menuArr.slice();
}


  // ====== STORAGE KEYS ======
  const KEY_ORDERS = "popupbar_orders_v2"; // bumped to v2 for clean schema
  const KEY_HELD = "popupbar_held_orders_v1";

  // ====== STATE ======
  let currentOrder = {};  // { drinkId: qty }
  let actionStack = [];   // for Undo
  let orderNote = "";
  let activeHeldIndex = null; // index of held order currently being worked on

  // ====== HELPERS ======

function applyTapFeedback(btn, e){
  const r = btn.getBoundingClientRect();
  const x = ((e.clientX || (r.left + r.width/2)) - r.left) / r.width * 100;
  const y = ((e.clientY || (r.top + r.height/2)) - r.top) / r.height * 100;
  btn.style.setProperty("--rx", x + "%");
  btn.style.setProperty("--ry", y + "%");

  btn.classList.add("flash");
  setTimeout(() => btn.classList.remove("flash"), 180);
}
  
function findDrink(id){
  return DRINKS.find(d => d.id === id);
}

function openVariantModal(group){
  const modal = document.getElementById("variant-modal");
  const title = document.getElementById("variant-title");
  const list = document.getElementById("variant-list");

  title.textContent = group.label + " options";
  list.innerHTML = "";

  group.options.forEach(drinkId => {
    const d = findDrink(drinkId);
    if(!d) return;

    const b = document.createElement("button");
    b.type = "button";
    b.className = "drink";
    const thumb = d.img ? `<img class="thumb" src="${escapeHtml(d.img)}" alt="">` : "";
    b.innerHTML = `${thumb}<div class="name">${escapeHtml(d.name)}</div><div class="price">${money(d.price)}</div>`;

    b.addEventListener("click", (e) => {
  applyTapFeedback(b, e);
  addToOrder(d.id, 1);

  // close after the flash so you see the feedback
  setTimeout(() => { modal.style.display = "none"; }, 140);
});

    list.appendChild(b);
  });

  modal.style.display = "flex";
}
 
  const money = (n) => "¬£" + (Math.round(Number(n || 0) * 100) / 100).toFixed(2);
  const nowStamp = () => new Date().toISOString();

  function drinkById(id){ return DRINKS.find(d => d.id === id); }

  function loadOrders(){
    try { return JSON.parse(localStorage.getItem(KEY_ORDERS) || "[]"); }
    catch { return []; }
  }
  function saveOrders(orders){
    localStorage.setItem(KEY_ORDERS, JSON.stringify(orders));
  }

  function loadHeld(){
    try { return JSON.parse(localStorage.getItem(KEY_HELD) || "[]"); }
    catch { return []; }
  }
  function saveHeld(held){
    localStorage.setItem(KEY_HELD, JSON.stringify(held));
  }


  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }

  function csvSafe(s){
    const str = String(s ?? "");
    const needs = /[",\n]/.test(str);
    const escaped = str.replaceAll('"', '""');
    return needs ? `"${escaped}"` : escaped;
  }

  function currentTotal(){
    return Object.entries(currentOrder).reduce((sum, [id, qty]) => {
      const d = drinkById(id);
      if(!d) return sum;
      return sum + d.price * qty;
    }, 0);
  }

  function formatLastTime(iso){
    if(!iso) return "‚Äî";
    const dt = new Date(iso);
    if(Number.isNaN(dt.getTime())) return "‚Äî";
    return dt.toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit" });
  }

  // ====== STATUS BAR ======
  function updateStatusBar(){
    const orders = loadOrders();
    let revenue = 0, cashTotal = 0, cardTotal = 0;

    for(const o of orders){
      const t = Number(o.total || 0);
      revenue += t;
      if(o.payment === "cash") cashTotal += t;
      if(o.payment === "card") cardTotal += t;
    }

    document.getElementById("sb-orders").textContent = String(orders.length);
    document.getElementById("sb-revenue").textContent = money(revenue);
    document.getElementById("sb-cash").textContent = money(cashTotal);
    document.getElementById("sb-card").textContent = money(cardTotal);
    document.getElementById("sb-last").textContent = formatLastTime(orders[0]?.time);
  }

  // Admin open: long-press title
let lpTimer = null;
const titleEl = document.getElementById("app-title");

titleEl.addEventListener("touchstart", () => {
  lpTimer = setTimeout(() => {
    const pin = prompt("Admin PIN:");
    if(pin === null) return;
    if(pin === ADMIN_PIN) openAdmin();
    else alert("Wrong PIN");
  }, 900);
}, { passive: true });

titleEl.addEventListener("touchend", () => { clearTimeout(lpTimer); lpTimer = null; });

// Admin buttons
document.getElementById("admin-close").addEventListener("click", closeAdmin);
document.getElementById("admin-add").addEventListener("click", () => {
  adminDraft.push({ id: "new-drink", name: "New drink", price: 0.00, img: "" });
  renderAdminTable();
});
document.getElementById("admin-save").addEventListener("click", applyAdminMenu);
document.getElementById("admin-reset").addEventListener("click", () => {
  if(confirm("Reset menu to default?")){
    localStorage.removeItem(KEY_MENU);
    DRINKS = DRINKS_DEFAULT.map(d => ({ ...d }));
    renderMenu();
    renderCurrentOrder();
  renderHeld();
    renderOrders();
    renderSummary();
    updateStatusBar();
    closeAdmin();
  }
});

  // ====== OVERLAY ======
  function showOrderCompleteOverlay(total){
    const overlay = document.getElementById("order-complete-overlay");
    const totalEl = document.getElementById("oco-total");
    totalEl.textContent = money(total);
    overlay.style.display = "flex";
    setTimeout(() => { overlay.style.display = "none"; }, 1500);
  }

  // ====== PAYMENT MODAL ======
  let pendingPayResolve = null;

  function openPayModal(){ document.getElementById("pay-modal").style.display = "flex"; }
  function closePayModal(){ document.getElementById("pay-modal").style.display = "none"; }

  function choosePaymentMethod(){
    return new Promise((resolve) => {
      pendingPayResolve = resolve;
      openPayModal();
    });
  }

  function resolvePayment(method){
    closePayModal();
    if(pendingPayResolve){
      pendingPayResolve(method);
      pendingPayResolve = null;
    }
  }

  // ====== RENDER: MENU ======
  function renderMenu(){
    const grid = document.getElementById("drink-grid");
    grid.innerHTML = "";

// Build a set of drinks that are ‚Äúhidden‚Äù because they‚Äôre accessed via a group popup
const hidden = new Set();
VARIANT_GROUPS.forEach(g => g.options.forEach(id => hidden.add(id)));

// Render group buttons first
VARIANT_GROUPS.forEach(g => {
  const btn = document.createElement("button");
  btn.className = "drink";
  btn.type = "button";

  const thumb = g.img ? `<img class="thumb" src="${escapeHtml(g.img)}" alt="">` : "";
  btn.innerHTML = `${thumb}<div class="name">${escapeHtml(g.label)}</div><div class="price">Tap for sizes</div>`;

  btn.addEventListener("click", (e) => {
  applyTapFeedback(btn, e);
  openVariantModal(g);
});

  grid.appendChild(btn);
});    

    DRINKS.forEach(d => {
      if(hidden.has(d.id)) return; // don‚Äôt show variant items as separate buttons
      const btn = document.createElement("button");
      btn.className = "drink";
      btn.type = "button";
      const thumb = d.img ? `<img class="thumb" src="${escapeHtml(d.img)}" alt="" loading="lazy">` : `<div class="thumb placeholder"></div>`;

btn.innerHTML = `
  ${thumb}
  <div class="name">${escapeHtml(d.name)}</div>
  <div class="price">${money(d.price)}</div>
`;


      btn.addEventListener("click", (e) => {
        // flash + ripple origin
        const r = btn.getBoundingClientRect();
        const x = ((e.clientX || (r.left + r.width/2)) - r.left) / r.width * 100;
        const y = ((e.clientY || (r.top + r.height/2)) - r.top) / r.height * 100;
        btn.style.setProperty("--rx", x + "%");
        btn.style.setProperty("--ry", y + "%");

        btn.classList.add("flash");
        setTimeout(() => btn.classList.remove("flash"), 180);

        addToOrder(d.id, 1);
      });

      grid.appendChild(btn);
    });
  }

  // ====== ORDER OPS ======
  function addToOrder(id, qty){
    currentOrder[id] = (currentOrder[id] || 0) + qty;
    if(currentOrder[id] <= 0) delete currentOrder[id];
    actionStack.push({ type: "add", id, qty });
    renderCurrentOrder();
  }

  function clearOrder(){
    currentOrder = {};
    actionStack = [];
    orderNote = "";
    renderCurrentOrder();
  }

  function undo(){
    const last = actionStack.pop();
    if(!last) return;
    if(last.type === "add"){
      currentOrder[last.id] = (currentOrder[last.id] || 0) - last.qty;
      if(currentOrder[last.id] <= 0) delete currentOrder[last.id];
    }
    renderCurrentOrder();
  }

  // ====== HOLD / RECALL (does NOT count as a sale) ======
  function holdCurrentOrder(){
    const entries = Object.entries(currentOrder);
    if(entries.length === 0) return;

    const held = loadHeld();

    const lines = entries.map(([id, qty]) => {
      const d = drinkById(id);
      return {
        id,
        name: d?.name || id,
        price: Number(d?.price || 0),
        qty: Number(qty || 0),
        lineTotal: Number(d?.price || 0) * Number(qty || 0),
        img: d?.img || ""
      };
    });

    held.unshift({
      time: nowStamp(),
      note: orderNote || "",
      total: currentTotal(),
      lines
    });

    // Keep the most recent 10 held orders
    while(held.length > 10) held.pop();

    saveHeld(held);

    activeHeldIndex = null;
    clearOrder();     // clears + re-renders current order
    renderHeld();     // show chips immediately
  }

  function recallHeld(index){
    const held = loadHeld();
    const item = held[index];
    if(!item) return;

    if(Object.keys(currentOrder).length > 0){
      const ok = confirm("Replace current order with this held order?");
      if(!ok) return;
    }

    activeHeldIndex = index;

    currentOrder = {};
    (item.lines || []).forEach(l => {
      currentOrder[l.id] = (currentOrder[l.id] || 0) + Number(l.qty || 0);
    });
    orderNote = item.note || "";

    renderCurrentOrder();
    renderHeld();
  }

  function clearActiveHold(){
    if(activeHeldIndex === null) return;

    const ok = confirm("Clear this held order?\n\nThis will discard it and cannot be undone.");
    if(!ok) return;

    const held = loadHeld();
    held.splice(activeHeldIndex, 1);
    saveHeld(held);

    activeHeldIndex = null;
    clearOrder();
    renderHeld();
  }


  function deleteHeld(index){
    const held = loadHeld();
    held.splice(index, 1);
    saveHeld(held);
    renderHeld();
  }

  function renderHeld(){
    const wrap = document.getElementById("held-wrap");
    const list = document.getElementById("held-list");
    if(!wrap || !list) return;

    const held = loadHeld();

    if(held.length === 0){
      wrap.style.display = "none";
      list.innerHTML = "";
      return;
    }

    wrap.style.display = "block";
    list.innerHTML = "";

    held.forEach((h, idx) => {
      const itemsCount = (h.lines || []).reduce((s,l) => s + Number(l.qty || 0), 0);
      const t = new Date(h.time);
      const timeStr = isNaN(t.getTime()) ? "" : t.toLocaleTimeString(undefined, { hour:"2-digit", minute:"2-digit" });

      const chip = document.createElement("div");
      chip.className = "held-chip" + (activeHeldIndex === idx ? " active" : "");
      chip.innerHTML = `
        <div>
          Hold ${idx + 1} ¬∑ ${money(h.total)}
          <div class="sub">${itemsCount} items ¬∑ ${timeStr}${h.note ? " ¬∑ " + escapeHtml(h.note) : ""}</div>
        </div>
      `;

      chip.addEventListener("click", () => recallHeld(idx));
      list.appendChild(chip);
    });
  }

  // ====== RENDER: CURRENT ORDER ======
  function renderCurrentOrder(){
    const tbody = document.getElementById("order-lines");
    const entries = Object.entries(currentOrder);

    const completeBtn = document.getElementById("btn-complete");
    const holdBtn = document.getElementById("btn-hold");
    const clearHeldBtn = document.getElementById("btn-clear-held");
    const noteEl = document.getElementById("order-note");

    // Show Clear Hold only when working on a recalled held order
    if(clearHeldBtn){
      clearHeldBtn.style.display = (activeHeldIndex !== null) ? "" : "none";
    }
    // Hide Hold button while working a recalled held order
    if(holdBtn){
      holdBtn.style.display = (activeHeldIndex !== null) ? "none" : "";
    }

    function setActionEnabled(enabled){
      if(completeBtn){
        if(enabled){
          completeBtn.disabled = false;
          completeBtn.removeAttribute("disabled");
        } else {
          completeBtn.disabled = true;
          completeBtn.setAttribute("disabled", "disabled");
        }
      }
      if(holdBtn){
        // Only enable Hold if not currently working on a held order
        const canHold = enabled && (activeHeldIndex === null);
        if(canHold){
          holdBtn.disabled = false;
          holdBtn.removeAttribute("disabled");
        } else {
          holdBtn.disabled = true;
          holdBtn.setAttribute("disabled", "disabled");
        }
      }
    }

    // keep held tray updated
    renderHeld();
if(entries.length === 0){
      tbody.innerHTML = `<tr><td colspan="3" class="muted">No items yet.</td></tr>`;
      document.getElementById("order-total").textContent = money(0);
      setActionEnabled(false);
      noteEl.style.display = "none";
      return;
    }

    tbody.innerHTML = "";
    entries
      .sort((a,b) => drinkById(a[0]).name.localeCompare(drinkById(b[0]).name))
      .forEach(([id, qty]) => {
        const d = drinkById(id);
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.innerHTML = `<div style="font-weight:800;">${escapeHtml(d.name)}</div><div class="muted">${money(d.price)} each</div>`;

        const tdQty = document.createElement("td");
        tdQty.innerHTML = `
          <div class="qtyControls">
            <button type="button" class="btn" data-dec>-</button>
            <div style="min-width:28px; text-align:center; font-weight:900;">${qty}</div>
            <button type="button" class="btn" data-inc>+</button>
          </div>
        `;

        tdQty.querySelector("[data-dec]").addEventListener("click", () => addToOrder(id, -1));
        tdQty.querySelector("[data-inc]").addEventListener("click", () => addToOrder(id, 1));

        const tdLine = document.createElement("td");
        tdLine.style.fontWeight = "900";
        tdLine.textContent = money(d.price * qty);

        tr.appendChild(tdName);
        tr.appendChild(tdQty);
        tr.appendChild(tdLine);
        tbody.appendChild(tr);
      });

    document.getElementById("order-total").textContent = money(currentTotal());
    setActionEnabled(true);

    if(orderNote){
      noteEl.style.display = "block";
      noteEl.textContent = "Note: " + orderNote;
    } else {
      noteEl.style.display = "none";
    }
  }

  // ====== COMPLETE ORDER (with payment) ======
  async function completeOrderWithPay(){
    const lines = Object.entries(currentOrder).map(([id, qty]) => {
      const d = drinkById(id);
      return { id, name: d.name, price: d.price, qty, lineTotal: d.price * qty };
    });
    if(lines.length === 0) return;

    const payment = await choosePaymentMethod();
    if(!payment) return; // cancelled

    const total = currentTotal();

    const order = {
      time: nowStamp(),
      note: orderNote || "",
      total,
      payment, // "cash" | "card"
      lines
    };

    const orders = loadOrders();
    orders.unshift(order);
    saveOrders(orders);

    // If we were working on a held order, remove it from Held now
    if(activeHeldIndex !== null){
      const held = loadHeld();
      held.splice(activeHeldIndex, 1);
      saveHeld(held);
      activeHeldIndex = null;
      renderHeld();
    }

    clearOrder();
    renderOrders();
    renderSummary();

    // Always show confirmation first; then update status bar
    switchTab("order");
    showOrderCompleteOverlay(total);
    updateStatusBar();
  }

  // ====== RENDER: ORDERS LIST ======
  function renderOrders(){
    const orders = loadOrders();
    const tbody = document.getElementById("orders-list");
    const detail = document.getElementById("order-detail");
    detail.style.display = "none";
    detail.innerHTML = "";

    if(orders.length === 0){
      tbody.innerHTML = `<tr><td colspan="3" class="muted">No completed orders yet.</td></tr>`;
      return;
    }

    tbody.innerHTML = "";
    orders.forEach((o) => {
      const dt = new Date(o.time);
      const timeStr = dt.toLocaleString(undefined, { hour: "2-digit", minute: "2-digit", day: "2-digit", month: "short" });
      const itemsCount = (o.lines || []).reduce((s,l) => s + (l.qty || 0), 0);
      const payLabel = o.payment === "cash" ? "Cash" : (o.payment === "card" ? "Card" : "");

      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.innerHTML = `<td>${timeStr}</td><td>${itemsCount}</td><td style="font-weight:900;">${money(o.total)} <span class="muted">(${payLabel})</span></td>`;

      tr.addEventListener("click", () => {
        const linesHtml = (o.lines || [])
          .map(l => `<tr><td>${escapeHtml(l.name)}</td><td>${l.qty}</td><td>${money(l.lineTotal)}</td></tr>`)
          .join("");

        detail.innerHTML = `
          <div style="font-weight:900; margin-bottom:8px;">Order Detail</div>
          ${o.note ? `<div class="muted" style="margin-bottom:10px;">Note: ${escapeHtml(o.note)}</div>` : ""}
          <div class="muted" style="margin-bottom:10px;">Payment: ${escapeHtml(payLabel || "‚Äî")}</div>
          <table>
            <thead><tr><th>Item</th><th style="width:120px;">Qty</th><th style="width:140px;">Line</th></tr></thead>
            <tbody>${linesHtml}</tbody>
          </table>
          <div class="row" style="margin-top:10px;">
            <div class="muted">Order Total</div>
            <div style="font-weight:950; font-size:18px;">${money(o.total)}</div>
          </div>
        `;
        detail.style.display = "block";
      });

      tbody.appendChild(tr);
    });
  }

  // ====== RENDER: SUMMARY ======
  function renderSummary(){
    const orders = loadOrders();
    const revenue = orders.reduce((s,o) => s + (o.total || 0), 0);
    document.getElementById("summary-revenue").textContent = money(revenue);

    const agg = {}; // {id: {name, qty, sales}}
    orders.forEach(o => {
      (o.lines || []).forEach(l => {
        if(!agg[l.id]) agg[l.id] = { name: l.name, qty: 0, sales: 0 };
        agg[l.id].qty += l.qty;
        agg[l.id].sales += l.lineTotal;
      });
    });

    const rows = Object.values(agg).sort((a,b) => b.qty - a.qty);
    const tbody = document.getElementById("summary-table");

    if(rows.length === 0){
      tbody.innerHTML = `<tr><td colspan="3" class="muted">No sales yet.</td></tr>`;
      return;
    }

    tbody.innerHTML = rows.map(r =>
      `<tr><td>${escapeHtml(r.name)}</td><td>${r.qty}</td><td style="font-weight:900;">${money(r.sales)}</td></tr>`
    ).join("");
  }

  // ====== EXPORT ======
  function exportCSV(){
    const orders = loadOrders();
    // Order-level CSV plus line-level rows
    const headers = ["order_time","payment","order_note","order_total","drink_id","drink_name","qty","unit_price","line_total"];
    const lines = [headers.join(",")];

    orders.slice().reverse().forEach(o => {
      (o.lines || []).forEach(l => {
        const row = [
          csvSafe(o.time),
          csvSafe(o.payment || ""),
          csvSafe(o.note || ""),
          Number(o.total || 0).toFixed(2),
          csvSafe(l.id),
          csvSafe(l.name),
          l.qty,
          Number(l.price || 0).toFixed(2),
          Number(l.lineTotal || 0).toFixed(2)
        ];
        lines.push(row.join(","));
      });
    });

    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `popup-bar-sales-${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ====== CLEAR DAY ======
  function clearAll(){
  const pin = prompt("Admin PIN required to clear the day:");
  if(pin === null) return;
  if(pin !== ADMIN_PIN){
    alert("Wrong PIN");
    return;
  }

  if(confirm("Clear all completed orders for the day? This cannot be undone.")){
    localStorage.removeItem(KEY_ORDERS);
    clearOrder();
    renderOrders();
    renderSummary();
    updateStatusBar();
    switchTab("order");
  }
}

  // ====== TABS ======
  function switchTab(which){
    const tabs = {
      order: document.getElementById("tab-order"),
      orders: document.getElementById("tab-orders"),
      summary: document.getElementById("tab-summary"),
    };
    Object.values(tabs).forEach(t => t.classList.remove("active"));
    tabs[which].classList.add("active");

    document.getElementById("view-order").style.display = (which === "order") ? "" : "none";
    document.getElementById("view-orders").style.display = (which === "orders") ? "" : "none";
    document.getElementById("view-summary").style.display = (which === "summary") ? "" : "none";
  }

  // ====== WIRING ======

  document.getElementById("variant-modal").addEventListener("click", (e) => {
  if(e.target.id === "variant-modal") e.target.style.display = "none";
});

document.getElementById("variant-close").addEventListener("click", () => {
  document.getElementById("variant-modal").style.display = "none";
});

  document.getElementById("admin-export").addEventListener("click", exportMenu);
  document.getElementById("admin-import").addEventListener("click", importMenu);

  document.getElementById("tab-order").addEventListener("click", () => switchTab("order"));
  document.getElementById("tab-orders").addEventListener("click", () => { renderOrders(); switchTab("orders"); });
  document.getElementById("tab-summary").addEventListener("click", () => { renderSummary(); switchTab("summary"); });

  document.getElementById("btn-clear-order").addEventListener("click", clearOrder);
  document.getElementById("btn-undo").addEventListener("click", undo);
  document.getElementById("btn-hold").addEventListener("click", holdCurrentOrder);
  document.getElementById("btn-clear-held").addEventListener("click", clearActiveHold);
  document.getElementById("btn-complete").addEventListener("click", completeOrderWithPay);

  document.getElementById("btn-export").addEventListener("click", exportCSV);
  document.getElementById("btn-clear-all").addEventListener("click", clearAll);
  document.getElementById("btn-refresh-summary").addEventListener("click", () => { renderSummary(); updateStatusBar(); });

  document.getElementById("pay-cash").addEventListener("click", () => resolvePayment("cash"));
  document.getElementById("pay-card").addEventListener("click", () => resolvePayment("card"));
  document.getElementById("pay-cancel").addEventListener("click", () => resolvePayment(null));

  document.getElementById("btn-edit-note").addEventListener("click", () => {
    const n = prompt("Optional note (e.g., table number / comp / etc.):", orderNote);
    if(n === null) return;
    orderNote = n.trim();
    renderCurrentOrder();
  });

  // ====== INIT ======
  renderMenu();
  renderCurrentOrder();
  renderHeld();
  renderOrders();
  renderSummary();
  updateStatusBar();


// ===== Settings (Phase 1): Theme + Scale =====
const KEY_SETTINGS = "popupbar_display_settings_v1";
const DEFAULT_SETTINGS = { theme: "dark", scale: 1.0 };

function loadSettings(){
  try{
    const raw = localStorage.getItem(KEY_SETTINGS);
    if(!raw) return { ...DEFAULT_SETTINGS };
    const s = JSON.parse(raw);
    return {
      theme: (s.theme === "light" || s.theme === "hc") ? s.theme : "dark",
      scale: (typeof s.scale === "number" && s.scale >= 0.85 && s.scale <= 1.25) ? s.scale : 1.0
    };
  } catch {
    return { ...DEFAULT_SETTINGS };
  }
}
function saveSettings(s){
  localStorage.setItem(KEY_SETTINGS, JSON.stringify(s));
}

let displaySettings = loadSettings();

function applySettings(){
  document.documentElement.setAttribute("data-theme", displaySettings.theme);
  document.documentElement.style.setProperty("--ui-scale", String(displaySettings.scale));

  const scaleLabel = document.getElementById("scale-label");
  if(scaleLabel) scaleLabel.textContent = Math.round(displaySettings.scale * 100) + "%";

  // Update active state on buttons
  const seg = document.getElementById("theme-seg");
  if(seg){
    seg.querySelectorAll("button[data-theme]").forEach(b=>{
      b.classList.toggle("active", b.getAttribute("data-theme") === displaySettings.theme);
    });
  }
}

function openSettings(){
  const m = document.getElementById("settings-modal");
  if(!m) return;
  m.style.display = "flex";
  m.setAttribute("aria-hidden","false");

  const slider = document.getElementById("ui-scale");
  if(slider) slider.value = String(displaySettings.scale);
  applySettings();
}

function closeSettings(){
  const m = document.getElementById("settings-modal");
  if(!m) return;
  m.style.display = "none";
  m.setAttribute("aria-hidden","true");
}

function bindSettingsUI(){
  const btn = document.getElementById("btn-settings");
  const btnClose = document.getElementById("btn-settings-close");
  const btnReset = document.getElementById("btn-settings-reset");
  const slider = document.getElementById("ui-scale");
  const seg = document.getElementById("theme-seg");
  const modal = document.getElementById("settings-modal");

  if(btn) btn.addEventListener("click", openSettings);
  if(btnClose) btnClose.addEventListener("click", closeSettings);
  if(modal) modal.addEventListener("click", (e)=>{ if(e.target && e.target.id === "settings-modal") closeSettings(); });

  if(seg){
    seg.querySelectorAll("button[data-theme]").forEach(b=>{
      b.addEventListener("click", ()=>{
        displaySettings.theme = b.getAttribute("data-theme") || "dark";
        saveSettings(displaySettings);
        applySettings();
      });
    });
  }

  if(slider){
    slider.addEventListener("input", ()=>{
      displaySettings.scale = Number(slider.value);
      saveSettings(displaySettings);
      applySettings();
    });
  }

  if(btnReset){
    btnReset.addEventListener("click", ()=>{
      displaySettings = { ...DEFAULT_SETTINGS };
      saveSettings(displaySettings);
      applySettings();
    });
  }
}

// Apply immediately on load (before user taps anything)
applySettings();
// Bind after DOM exists
window.addEventListener("load", bindSettingsUI);

</script>

<!-- Settings button (fixed top-left) -->
<button id="btn-settings" type="button" title="Settings">‚öôÔ∏è</button>

<!-- Settings modal -->
<div id="settings-modal" aria-hidden="true">
  <div class="settings-card">
    <div class="settings-row" style="margin-bottom:10px;">
      <div>
        <div class="settings-title">Settings</div>
        <div class="muted">Theme + readability for sunny days.</div>
      </div>
      <button type="button" class="btn" id="btn-settings-close">Close</button>
    </div>

    <div class="spacer"></div>

    <div style="font-weight:900; margin-bottom:8px;">Theme</div>
    <div class="seg" id="theme-seg">
      <button type="button" data-theme="dark">Dark</button>
      <button type="button" data-theme="light">Light</button>
      <button type="button" data-theme="hc">High Contrast</button>
    </div>

    <div class="spacer"></div>

    <div class="settings-row" style="gap:14px;">
      <div style="font-weight:900;">UI Scale</div>
      <div class="muted" id="scale-label">100%</div>
    </div>
    <input id="ui-scale" type="range" min="0.85" max="1.25" step="0.01" value="1.00" />

    <div class="spacer"></div>

    <div class="settings-row">
      <button type="button" class="btn danger" id="btn-settings-reset">Reset</button>
      <div class="muted">Saved on this device.</div>
    </div>
  </div>
</div>

</body>
</html>
